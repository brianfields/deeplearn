# Ask Questions Feature Specification

## User Story

**As a** learner working through a lesson,
**I want to** ask questions to a teaching assistant at any point during my learning session,
**So that** I can get immediate help understanding concepts, clarify confusing material, or explore topics more deeply without leaving the lesson flow.

### User Experience

**Entry Point:**
- A floating "Ask Questions" button appears throughout the learning session (visible at all times)
- Button shows online/offline status indicator
- When offline, tapping the button shows: "Teaching assistant requires internet connection"

**Opening the Assistant:**
- Tapping the button opens a modal overlay with the teaching assistant interface
- The assistant greets the learner with a contextualized introduction based on:
  - Current position in the lesson (podcast finished? On exercise 3 of 8?)
  - Recent exercise performance (just got one wrong? Perfect streak?)
  - Lesson subject matter and learning objectives
- The assistant suggests 2-4 quick reply options the learner might want to ask

**Conversation Flow:**
- Learner can type custom questions or tap suggested quick replies
- After each learner message, the assistant responds with:
  - Helpful explanation or guidance (without giving away exercise answers)
  - 2-4 new contextual quick reply suggestions
- Conversation history persists throughout the entire unit (not just this lesson)
- Learner can close the modal and return anytime - conversation resumes where they left off
- Learning session timer continues running while the assistant modal is open

**Context Awareness:**
- The assistant has full context on:
  - All lesson material (mini-lesson content, exercise questions/answers, learning objectives)
  - Unit source material and learning objectives
  - Current learning session progress (which exercises attempted, results, time spent)
  - Historical unit progress (previous lessons completed, overall performance)
  - Resources attached to the unit
- The assistant can reference specific exercises: "I noticed you selected option B on the recursion question. Let me explain why option C is correct..."

**Returning to the Lesson:**
- Learner closes the modal to continue the lesson
- All conversation history is saved and visible in the admin dashboard alongside the learning session

**Admin Visibility:**
- Admins can view all teaching assistant conversations for a unit
- Transcripts appear alongside learning session data for analysis

---

## Requirements Summary

### Functional Requirements

1. **Floating Button UI**
   - Always visible during learning sessions
   - Shows online/offline status
   - Disabled with explanation when offline

2. **Teaching Assistant Modal**
   - Full-screen or large modal overlay
   - Conversation interface with message bubbles
   - Quick reply suggestions (2-4 options)
   - Text input for custom questions
   - Close/minimize button

3. **Contextualized Introduction**
   - Assistant introduces itself on first open
   - Makes intelligent guess about learner's likely question based on:
     - Current exercise/progress
     - Recent performance
     - Lesson topic
   - Falls back to generic greeting with lesson topic if no high-confidence guess

4. **Conversation Persistence**
   - Conversations scoped to unit (not lesson or session)
   - History persists across lessons within the same unit
   - Resume conversation when reopening modal

5. **Rich Context Access**
   - Lesson content (all sections, exercises, learning objectives)
   - Unit metadata (source material, unit learning objectives, resources)
   - Current session state (exercise attempts, answers, correctness, time)
   - Unit progress (completed lessons, historical performance)

6. **Suggested Quick Replies**
   - Generated by LLM at each conversation turn
   - Context-aware and relevant to current state
   - Never reveal answers to exercises the learner is working on
   - Can include meta actions ("I'm ready to continue", "Show me an example")

7. **Online-Only Operation**
   - Check network status before allowing access
   - Show clear messaging when offline
   - Handle connectivity loss gracefully during conversation

8. **Admin Dashboard Integration**
   - Teaching assistant transcripts visible alongside learning session data
   - Filterable by user, unit, date
   - Full conversation history with timestamps

### Non-Functional Requirements

1. **Performance**
   - Modal opens instantly (no blocking on network)
   - LLM responses stream in real-time
   - Quick reply generation happens in parallel with message response

2. **Reliability**
   - Conversation state persists to backend immediately
   - Handle network failures gracefully
   - Retry failed requests

3. **Modularity**
   - Teaching assistant is a conversation type within `learning_conversations` module
   - Clean separation from learning coach (different conversation type)
   - Reuse conversation UI components (MessageBubble, QuickReplies, Composer)

### Acceptance Criteria

- [ ] Learner can open teaching assistant modal at any point during a learning session
- [ ] Button is disabled with explanation when device is offline
- [ ] Assistant provides contextualized greeting on first open
- [ ] Assistant has access to all lesson content, unit metadata, and session progress
- [ ] Conversation persists across lessons within the same unit
- [ ] Suggested quick replies are generated at each turn and are contextually relevant
- [ ] Assistant responses do not reveal answers to exercises learner is working on
- [ ] Learner can close modal and resume conversation later
- [ ] Learning session timer continues running while modal is open
- [ ] Admin dashboard shows teaching assistant transcripts for each unit
- [ ] All lint checks pass
- [ ] All backend unit tests pass
- [ ] All frontend unit tests pass
- [ ] All backend integration tests pass
- [ ] Existing maestro tests pass with any necessary updates

---

## Cross-Stack Module Mapping

### Backend Modules

#### 1. `learning_conversations` (renamed from `learning_coach`)
**Purpose:** Orchestrates both learning coach (unit planning) and teaching assistant (lesson Q&A) conversations.

**Changes:**
- **Rename module** from `learning_coach` to `learning_conversations`
- **Refactor:** Move `conversation.py` → `conversations/learning_coach.py`
- **Add:** `conversations/teaching_assistant.py` - New `TeachingAssistantConversation` class
- **Add:** `conversations/__init__.py` - Export both conversation classes
- **Add:** `prompts/teaching_assistant_system_prompt.md` - System prompt for assistant
- **Modify:** `service.py` - Add teaching assistant methods
- **Modify:** `public.py` - Rename provider, add teaching assistant methods to Protocol
- **Modify:** `routes.py` - Add teaching assistant routes
- **Modify:** `dtos.py` - Add `TeachingAssistantSessionState`, context DTOs
- **Update:** `test_learning_coach_unit.py` - Update imports, add teaching assistant tests

**New Routes:**
- `POST /api/v1/learning_conversations/teaching_assistant/start` - Start or resume teaching assistant conversation
- `POST /api/v1/learning_conversations/teaching_assistant/ask` - Submit learner question
- `GET /api/v1/learning_conversations/teaching_assistant/{conversation_id}` - Get conversation state

**Public Interface Changes:**
- Rename: `learning_coach_provider` → `learning_conversations_provider`
- Add: `start_teaching_assistant_session(unit_id, user_id, lesson_id, session_id)` → `TeachingAssistantSessionState`
- Add: `submit_teaching_assistant_question(conversation_id, message, user_id)` → `TeachingAssistantSessionState`

#### 2. `learning_session` (modifications only)
**Purpose:** Provide session context to teaching assistant.

**Changes:**
- **Modify:** `service.py` - Add `get_session_context_for_assistant(session_id)` method
- **Modify:** `public.py` - Add method to `LearningSessionProvider` Protocol
- **Update:** `test_learning_session_unit.py` - Add tests for new context method

**Public Interface Changes:**
- Add: `get_session_context_for_assistant(session_id)` → Returns session state, exercise history, and unit context

#### 3. `content` (verify only)
**Purpose:** Provide lesson and unit content to teaching assistant.

**Changes:**
- **Verify:** `public.py` exposes `get_lesson(lesson_id)` and `get_unit(unit_id)` (likely already present)
- No changes expected if methods exist

#### 4. `server.py` (update import)
**Changes:**
- Update router import: `from modules.learning_coach.routes import router` → `from modules.learning_conversations.routes import router`

#### 5. `admin` (update imports)
**Changes:**
- **Modify:** `service.py` - Update import from `learning_coach.public` to `learning_conversations.public`
- **Modify:** `routes.py` - Update import from `learning_coach.public` to `learning_conversations.public`

#### 6. `content_creator` (update imports)
**Changes:**
- **Modify:** `service/facade.py` - Update import from `learning_coach.public` to `learning_conversations.public`

---

### Frontend (Mobile) Modules

#### 1. `learning_conversations` (renamed from `learning_coach`)
**Purpose:** Handles both learning coach and teaching assistant conversations.

**Changes:**
- **Rename module** from `learning_coach` to `learning_conversations`
- **Add:** `components/TeachingAssistantModal.tsx` - Modal overlay UI
- **Add:** `components/TeachingAssistantButton.tsx` - Floating button component
- **Add:** `components/TeachingAssistantConversation.tsx` - Conversation UI (reuses MessageBubble, QuickReplies, Composer)
- **Modify:** `models.ts` - Add `TeachingAssistantSessionState`, `TeachingAssistantMessage` DTOs
- **Modify:** `service.ts` - Add teaching assistant methods
- **Modify:** `public.ts` - Rename provider, add teaching assistant methods
- **Modify:** `repo.ts` - Add teaching assistant API calls
- **Modify:** `queries.ts` - Add teaching assistant React Query hooks
- **Keep:** All existing learning coach components (rename paths in imports)
- **Update:** `test_learning_coach_unit.ts` - Update imports, add teaching assistant tests

**Public Interface Changes:**
- Rename: `learningCoachProvider` → `learningConversationsProvider`
- Add teaching assistant methods matching backend

#### 2. `learning_session` (modifications only)
**Purpose:** Integrate teaching assistant button into learning flow.

**Changes:**
- **Modify:** `screens/LearningFlowScreen.tsx` - Add `TeachingAssistantButton` to screen, pass unit/session context
- **Modify:** `components/LearningFlow.tsx` - May need to pass session state up to screen for button context

#### 3. `infrastructure` (verify only)
**Purpose:** Check network status for teaching assistant availability.

**Changes:**
- **Verify:** `service.ts` has `isOnline()` or similar method for checking network status
- Add method if it doesn't exist

#### 4. `App.tsx` (update imports)
**Changes:**
- Update navigation/provider imports from `learning_coach` to `learning_conversations`

#### 5. `resource` (update imports)
**Changes:**
- **Modify:** `screens/AddResourceScreen.tsx` - Update import from `learning_coach` to `learning_conversations`

---

## Implementation Checklist

### Phase 1: Backend - Module Rename & Core Infrastructure

- [x] Rename `backend/modules/learning_coach` directory to `backend/modules/learning_conversations`
- [x] Create `backend/modules/learning_conversations/conversations/` directory
- [x] Move `backend/modules/learning_conversations/conversation.py` to `backend/modules/learning_conversations/conversations/learning_coach.py`
- [x] Create `backend/modules/learning_conversations/conversations/__init__.py` and export `LearningCoachConversation`
- [x] Update all imports in `learning_conversations` module files to reference new paths
- [x] Rename `learning_coach_provider` to `learning_conversations_provider` in `public.py`
- [x] Update `LearningConversationsProvider` Protocol name in `public.py`
- [x] Update route prefix in `routes.py` from `/api/v1/learning_coach` to `/api/v1/learning_conversations/coach`
- [x] Update `backend/server.py` router import to use `learning_conversations`
- [x] Update `backend/modules/admin/service.py` import from `learning_coach` to `learning_conversations`
- [x] Update `backend/modules/admin/routes.py` import from `learning_coach` to `learning_conversations`
- [x] Update `backend/modules/content_creator/service/facade.py` import from `learning_coach` to `learning_conversations`
- [x] Update any seed data scripts that reference `learning_coach`
- [x] Add `get_session_context_for_assistant(session_id)` method to `learning_session/service.py`
- [x] Method should return: session state, exercise attempt history, lesson metadata, unit metadata
- [x] Add method to `LearningSessionProvider` Protocol in `learning_session/public.py`
- [x] Verify `content` module's public interface exposes `get_lesson()` and `get_unit()`

### Phase 2: Backend - Teaching Assistant Implementation & Tests

- [x] Create `backend/modules/learning_conversations/prompts/teaching_assistant_system_prompt.md` with system prompt
- [x] Create `backend/modules/learning_conversations/conversations/teaching_assistant.py` with `TeachingAssistantConversation` class
- [x] Implement `@conversation_session` decorated methods in `TeachingAssistantConversation`:
  - [x] `start_session(_user_id, _conversation_id, unit_id, lesson_id, session_id)`
  - [x] `submit_question(_user_id, _conversation_id, message)`
- [x] Add context-building logic to fetch lesson, unit, session, and exercise data
- [x] Implement contextualized introduction generation based on session state
- [x] Add `TeachingAssistantConversation` to `conversations/__init__.py` exports
- [x] Add `TeachingAssistantSessionState` DTO to `dtos.py`
- [x] Add `TeachingAssistantMessage` DTO to `dtos.py`
- [x] Add `TeachingAssistantContext` helper DTO to `dtos.py`
- [x] Add `start_teaching_assistant_session()` method to `service.py`
- [x] Add `submit_teaching_assistant_question()` method to `service.py`
- [x] Add `get_teaching_assistant_session_state()` method to `service.py`
- [x] Update `LearningConversationsProvider` Protocol in `public.py` with teaching assistant methods
- [x] Update `learning_conversations_provider()` factory to return service with new methods
- [x] Add teaching assistant routes to `routes.py`:
  - [x] `POST /api/v1/learning_conversations/teaching_assistant/start`
  - [x] `POST /api/v1/learning_conversations/teaching_assistant/ask`
  - [x] `GET /api/v1/learning_conversations/teaching_assistant/{conversation_id}`
- [x] Add request/response models for teaching assistant endpoints
- [x] Add error handling for teaching assistant routes
- [x] Rename `test_learning_coach_unit.py` imports to use `learning_conversations`
- [x] Add unit tests for `TeachingAssistantConversation.start_session()`
- [x] Add unit tests for `TeachingAssistantConversation.submit_question()`
- [x] Add unit tests for context-building logic
- [x] Add unit tests for `get_session_context_for_assistant()` in learning_session
- [ ] Update existing integration tests to use `learning_conversations` imports

### Phase 3: Frontend - Module Rename & Core Infrastructure

- [x] Rename `mobile/modules/learning_coach` directory to `mobile/modules/learning_conversations`
- [x] Update `mobile/App.tsx` imports from `learning_coach` to `learning_conversations`
- [x] Update `mobile/modules/resource/screens/AddResourceScreen.tsx` import
- [x] Rename `learningCoachProvider` to `learningConversationsProvider` in `public.ts`
- [x] Update all internal imports within the module to reference new paths
- [x] Add `TeachingAssistantSessionState` interface to `models.ts`
- [x] Add `TeachingAssistantMessage` interface to `models.ts`
- [x] Add API wire type interfaces for teaching assistant to `models.ts`
- [x] Add DTO conversion functions (`toTeachingAssistantSessionStateDTO`) to `models.ts`
- [x] Add teaching assistant API methods to `repo.ts`:
  - [x] `startTeachingAssistantSession(unitId, lessonId, sessionId, userId)`
  - [x] `submitTeachingAssistantQuestion(conversationId, message, userId)`
  - [x] `getTeachingAssistantSessionState(conversationId)`
- [x] Add `startTeachingAssistantSession()` method to `service.ts`
- [x] Add `submitTeachingAssistantQuestion()` method to `service.ts`
- [x] Add `getTeachingAssistantSessionState()` method to `service.ts`
- [x] Update `learningConversationsProvider` in `public.ts` to expose teaching assistant methods
- [x] Add `useStartTeachingAssistant()` mutation hook to `queries.ts`
- [x] Add `useSubmitTeachingAssistantQuestion()` mutation hook to `queries.ts`
- [x] Add `useTeachingAssistantSessionState()` query hook to `queries.ts`
- [x] Add query key helpers for teaching assistant
- [x] Verify `infrastructure/service.ts` has network status checking method
- [x] Add `isOnline()` method if it doesn't exist
- [x] Export method via `infrastructure/public.ts`

### Phase 4: Frontend - Teaching Assistant UI & Integration

- [x] Create `components/TeachingAssistantButton.tsx` - Floating button with online/offline indicator
- [x] Create `components/TeachingAssistantModal.tsx` - Full modal overlay container
- [x] Create `components/TeachingAssistantConversation.tsx` - Conversation UI (reuses MessageBubble, QuickReplies, Composer)
- [x] Add network status check to button (disable when offline with explanation)
- [x] Add modal open/close state management
- [x] Add conversation persistence logic (resume on reopen)
- [x] Add `TeachingAssistantButton` to `learning_session/screens/LearningFlowScreen.tsx`
- [x] Pass unit ID, lesson ID, and session ID to button component
- [x] Ensure button is always visible (floating/fixed position)
- [ ] Verify learning session timer continues running when modal is open
- [x] Handle modal state (open/close) without interfering with learning flow
- [x] Add testID attributes to teaching assistant button and modal for maestro tests

### Phase 5: Tests, Seed Data & Admin Dashboard

- [x] Rename test file imports to use `learning_conversations`
- [x] Add unit tests for teaching assistant service methods
- [x] Add unit tests for teaching assistant repo methods
- [x] Add unit tests for DTO conversion functions
- [ ] Add component tests for `TeachingAssistantButton`
- [ ] Add component tests for `TeachingAssistantModal`
- [ ] Update existing maestro e2e tests in `mobile/e2e/` to handle the new teaching assistant button (ensure tests don't break due to new UI element)
- [ ] Update `backend/scripts/create_seed_data.py` to create sample teaching assistant conversations if it creates learning coach data
- [ ] Verify admin dashboard can display teaching assistant conversations (may require admin module updates)
- [ ] Add filtering by conversation type (coach vs assistant) in admin dashboard if needed
- [ ] Ensure teaching assistant transcripts appear alongside learning session data in admin views

### Phase 6: Validation & Quality Assurance

- [ ] Ensure all acceptance criteria are met and if not, fix so that they are.
- [ ] Ensure lint passes, i.e. './format_code.sh --no-venv' runs clean.
- [ ] Ensure backend unit tests pass, i.e. cd backend && scripts/run_unit.py
- [ ] Ensure frontend unit tests pass, i.e. cd mobile && npm run test
- [ ] Ensure integration tests pass, i.e. cd backend && scripts/run_integration.py runs clean.
- [ ] Follow the instructions in codegen/prompts/trace.md to ensure the user story is implemented correctly.
- [ ] Fix any issues documented during the tracing of the user story in docs/specs/ask-questions/trace.md.
- [ ] Follow the instructions in codegen/prompts/modulecheck.md to ensure the new code is following the modular architecture correctly.
- [ ] Examine all new code that has been created and make sure all of it is being used; there is no dead code.

---

## Technical Design Notes

### Teaching Assistant System Prompt

The system prompt should:
- Define the assistant's role as a helpful tutor for the current lesson
- Emphasize not giving away answers to exercises the learner is currently working on
- Encourage Socratic questioning and conceptual understanding
- Include context sections for:
  - Lesson content and learning objectives
  - Current exercise (if applicable)
  - Recent exercise attempts and results
  - Unit learning objectives and source material
  - Resources attached to the unit

### Context Building Strategy

When starting or resuming a teaching assistant conversation:
1. Fetch current learning session (progress, current exercise, attempt history)
2. Fetch lesson content (all sections, exercises, learning objectives)
3. Fetch unit metadata (learning objectives, source material, resources)
4. Fetch unit session (completed lessons, historical performance)
5. Build structured context object with all data
6. Generate contextualized introduction based on:
   - If just completed an exercise: Reference the exercise and result
   - If on a specific exercise: Offer help with the topic
   - If just started lesson: Offer to preview key concepts
   - If no strong signal: Generic greeting with lesson topic

### Conversation Persistence

- Teaching assistant conversations are scoped to **unit** (not lesson or session)
- Use `conversation_metadata` to store: `unit_id`, `current_lesson_id`, `current_session_id`
- When reopening modal:
  1. Check if conversation exists for this unit and user
  2. If yes: Resume existing conversation, update `current_lesson_id` and `current_session_id` in metadata
  3. If no: Create new conversation with contextualized introduction
- Conversation type: `teaching_assistant` (distinct from `learning_coach`)

### Suggested Quick Replies Generation

Include in each assistant response structured output:
- `message: str` - The assistant's response
- `suggested_quick_replies: list[str]` - 2-4 contextual suggestions

Quick replies should:
- Be relevant to current conversation state
- Avoid revealing exercise answers
- Include both content questions and meta actions
- Adapt based on conversation length (e.g., offer "Continue lesson" after 3-4 turns)

### Online/Offline Handling

- Check network status before opening modal
- If offline: Show tooltip/toast "Teaching assistant requires internet connection"
- If connection lost during conversation: Show error banner, allow retry
- Button visual state: Online (full color), Offline (grayed out with slash icon)

### Admin Dashboard Integration

Teaching assistant conversations should appear:
- Alongside learning session data for the unit
- Filterable by conversation type (`teaching_assistant` vs `learning_coach`)
- With full transcript, timestamps, and metadata
- Linked to the specific learning session if applicable

---

## Architecture Compliance

This feature follows the modular architecture guidelines:

### Backend
- **Service returns DTOs**: `TeachingAssistantSessionState` is a Pydantic model
- **Public exposes Protocol**: `LearningConversationsProvider` Protocol with teaching assistant methods
- **Routes use service directly**: Routes call `LearningConversationsService` methods
- **Cross-module via public**: Teaching assistant accesses `learning_session` and `content` via their public interfaces
- **No routes without need**: Teaching assistant routes are needed for mobile client communication

### Frontend
- **Service returns DTOs**: All methods return DTO types from `models.ts`
- **Public is thin forwarder**: `public.ts` exposes service methods without logic
- **Queries call service**: React Query hooks call `service.ts` methods
- **Repo is module-scoped**: `repo.ts` only calls `learning_conversations` routes
- **Cross-module via public**: UI components may call other modules' public interfaces if needed for composition

### Conversation Engine
- Teaching assistant uses `BaseConversation` + `@conversation_session` decorator
- Leverages existing `conversation_engine` infrastructure (models, repo, service)
- No new ORM models needed (reuses `conversations` and `conversation_messages` tables)

---

## Open Questions / Future Enhancements

1. **Rate Limiting**: Should we limit the number of teaching assistant questions per session/unit?
2. **Analytics**: Should we track metrics like "questions per lesson", "topics most asked about"?
3. **Conversation Summarization**: Should we summarize long conversations to reduce context size?
4. **Voice Input**: Should we support voice-to-text for questions?
5. **Follow-up Notifications**: Should we notify learners if they leave a question unanswered?

These can be addressed in future iterations.

---

## Success Metrics

- % of learners who use teaching assistant during a lesson
- Average questions per lesson
- Correlation between teaching assistant usage and lesson completion rate
- Correlation between teaching assistant usage and exercise accuracy
- Common question topics (for content improvement)

---

## Deployment Notes

- No database migrations required (uses existing conversation_engine tables)
- Feature flag not needed (button can be deployed and will work when backend is deployed)
- Backend should be deployed before mobile to avoid API errors
- Admin dashboard changes should be deployed alongside backend

---

## Completion Criteria

This feature is complete when:
1. All checklist items are marked complete
2. All tests pass (unit, integration, maestro)
3. Code review approval from team
4. Lint and format checks pass
5. User story has been traced and verified per `codegen/prompts/trace.md`
6. Module architecture has been validated per `codegen/prompts/modulecheck.md`
7. No dead code exists in the implementation
